name: Publish to crates.io

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use version from Cargo.toml)'
        required: false
        type: string
      create-tag:
        description: 'Create git tag for this release'
        required: false
        type: boolean
        default: true
      dry-run:
        description: 'Perform a dry run (do not actually publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Check if version needs to be updated
        id: version-check
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "cargo_version=$CARGO_VERSION" >> $GITHUB_OUTPUT

          if [ -n "${{ inputs.version }}" ]; then
            if [ "${{ inputs.version }}" != "$CARGO_VERSION" ]; then
              echo "Version mismatch: Cargo.toml has $CARGO_VERSION but you specified ${{ inputs.version }}"
              echo "Please update Cargo.toml version first or leave version input empty"
              exit 1
            fi
          fi

          echo "Publishing version: $CARGO_VERSION"

      - name: Run tests
        run: |
          cargo fmt --check
          cargo clippy -- -Dwarnings
          cargo test

      - name: Build release
        run: cargo build --release

      - name: Dry run publish
        if: ${{ inputs.dry-run }}
        run: cargo publish --dry-run

      - name: Publish to crates.io
        if: ${{ !inputs.dry-run }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish

      - name: Create git tag
        if: ${{ !inputs.dry-run && inputs.create-tag }}
        run: |
          VERSION="${{ steps.version-check.outputs.cargo_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
